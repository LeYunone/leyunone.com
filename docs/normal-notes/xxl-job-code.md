---
date: 2024-09-22
title: Xxl-Jobæºç æ¶æ„é˜…è¯»å’Œåˆ†æ
category: 
  - ç¬”è®°
tag:
  - note
head:
  - - meta
    - name: keywords
      content: æºç é˜…è¯»,xxlJob,java,æ¶æ„
---
# Xxl-Jobæºç æ¶æ„é˜…è¯»å’Œåˆ†æ

xxl-jobæ˜¯ä¸€ä¸ªä¸šå†…éå¸¸è®¤å¯çš„ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œæ•´ä½“æ¶æ„æ¸…æ™°ï¼Œæµç¨‹ä¹Ÿä¸å¤æ‚ï¼ˆä¸åƒDubboæˆ–è€…Skywalking...é‚£æ ·ç»•æ¥ç»•å»ï¼‰

æ‰€ä»¥å¦‚æœæƒ³è‡ªå·±æ­å»ºä¸€ä¸ªä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œè¯»xxl-jobçš„æºç ä¸€å®šæ˜¯ä¸€ä¸ªå¯å¿«é€Ÿäº†è§£ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„æ·å¾„ï¼›

## æ¶æ„

![img](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-08/1.png)

æ¥è‡ªhttps://www.xuxueli.com/xxl-job/çš„æ¶æ„å›¾ï¼›

åˆ†ä¸ºè°ƒåº¦ä¸­å¿ƒçš„æœåŠ¡ç«¯å’Œæ‰§è¡Œå™¨æœåŠ¡çš„å®¢æˆ·ç«¯

å®¢æˆ·ç«¯ä»…åšæ‰§è¡Œä»»åŠ¡ä»¥åŠä¸æœåŠ¡ç«¯çš„åŸºæœ¬é€šè®¯ï¼ŒåŒ…æ‹¬æ³¨å†Œã€å›è°ƒ...

æœåŠ¡ç«¯åˆ™æ˜¯åŸºäºä»»åŠ¡è°ƒåº¦è¿™ä¸€ä¸šåŠ¡çš„å„ç±»è¡ç”ŸåŠŸèƒ½ï¼šæ—¥å¿—ã€é¢„è­¦ã€ç»Ÿç­¹ç­‰ç­‰...

## æ•´ä½“

ä½œä¸ºä¸€ä¸ªä»15å¹´å°±å¼€å§‹æ­å»ºçš„ç³»ç»Ÿï¼Œæ•´ä½“æ¶æ„ç»è¿‡äº†`æ— Spring` -> `Spring` -> `SpringBoot` æ‹†ç®±å³ç”¨çš„å†ç¨‹

ä»£ç ä¸­æœ‰ä¸€è‚¡å¾ˆåŸå§‹çš„é‡å‘³ï¼Œå¾ˆå¤šåœ°æ–¹æ²¡æœ‰Springçš„ç¯ç¯ç»•ç»•ï¼Œç›´æ¥ç›´å»ä¹Ÿä½¿å¾—æ•´ä½“çš„æ¶æ„é˜…è¯»èµ·æ¥éå¸¸éå¸¸çš„æ¸…æ™°æ˜ç¡®ï¼›

æ•´ä½“æ¥çœ‹ï¼Œå®Œæ•´çš„è°ƒåº¦ä¸­å¿ƒä¸€å®šæ˜¯ç”±è‡³å°‘ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆè¢«è°ƒåº¦è€…ï¼‰å’Œä¸€ä¸ªæœåŠ¡ç«¯ï¼ˆè°ƒåº¦è€…ï¼‰ç»„æˆï¼›å„æœ‰å…¶èŒï¼Œäº’ä¸å¹²æ‰°ï¼Œä»¥Httpè¿›è¡Œé€šè®¯ï¼›

å®¢æˆ·ç«¯è´Ÿè´£ï¼š

1. æ³¨å†Œæ‰§è¡Œå™¨
2. æ‰§è¡Œå®šæ—¶ä»»åŠ¡
3. ...

æœåŠ¡ç«¯è´Ÿè´£ï¼š

1. æ”¶é›†æ‰§è¡Œå™¨
2. è§¦å‘å®šæ—¶ä»»åŠ¡
3. ...

å®¢æˆ·ç«¯å­˜æ´»åˆ¤æ–­ä»¥åŠå„ç±»æ—¥å¿—è®°å½•ã€å›è°ƒã€æ³¨é”€ ...ç­‰ç­‰æ“ä½œåˆ™æ˜¯åŒæ–¹çº¦å®šä¿—æˆçš„ç»†èŠ‚å±‚é¢ã€‚

åœ¨`xxl-job`ä¸­ä¸¤ç«¯çš„é€šè®¯æŒ‡ä»¤åˆ†åˆ«æœ‰ï¼š

![img](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-19/1.png)

æ‰€ä»¥ä»æ•´ä½“ä¸Šæ¥çœ‹ï¼Œåªéœ€è¦äº†è§£å„æ–¹çš„æŒ‡ä»¤å‘èµ·ä¸ç»“æŸçš„é“¾è·¯å°±å¯ä»¥å¼„æ¸…æ•´ä¸ª`xxl-job` çš„è¿è¡Œæµç¨‹

## å®¢æˆ·ç«¯

å®¢æˆ·ç«¯æ˜¯å¼•å…¥ `xxl-job-core` åŒ…åæ‹†ç®±å³ç”¨å³è£…è½½

```xml
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
</dependency>
```
ç°ç‰ˆæœ¬çš„`xxl-job`ä¸SpringBootç¯å¢ƒå¼ºç»‘å®šï¼Œè§`XxlJobSpringExecutor` ç±»å®¢æˆ·ç«¯é¡¹ç›®å¯åŠ¨çš„åˆå§‹åŒ–æ–¹æ³•ï¼š

<img src="https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-23/1.png" style="zoom:67%;" />

åˆå§‹åŒ–åŠ¨ä½œæœ‰ä¸‰æ­¥ï¼š

1. ç»„è£…è¢« `@xxlJob` æ³¨è§£ä¿®é¥°çš„ç±»å’Œæ–¹æ³•ï¼Œæ³¨å†Œä»»åŠ¡æ‰§è¡Œå™¨
2.  åˆå§‹åŒ–é»˜è®¤å‚æ•°ï¼Œæ—¥å¿—ã€ä»¤ç‰Œã€è·¯ç”±....
3. å¯åŠ¨å®¢æˆ·ç«¯nettyé€šè®¯ï¼Œä¸æœåŠ¡ç«¯é€šè®¯

### 1\ æ³¨å†Œä»»åŠ¡æ‰§è¡Œå™¨

```java
    private void initJobHandlerMethodRepository(ApplicationContext applicationContext) {
        if (applicationContext == null) {
            return;
        }
        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, false, true);
        for (String beanDefinitionName : beanDefinitionNames) {

            // get bean
            Object bean = null;
            Lazy onBean = applicationContext.findAnnotationOnBean(beanDefinitionName, Lazy.class);
            if (onBean!=null){
                logger.debug("xxl-job annotation scan, skip @Lazy Bean:{}", beanDefinitionName);
                continue;
            }else {
                bean = applicationContext.getBean(beanDefinitionName);
            }
            Map<Method, XxlJob> annotatedMethods = null;   
            try {
                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),
                        new MethodIntrospector.MetadataLookup<XxlJob>() {
                            @Override
                            public XxlJob inspect(Method method) {
                                return AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);
                            }
                        });
            } catch (Throwable ex) {
                logger.error("xxl-job method-jobhandler resolve error for bean[" + beanDefinitionName + "].", ex);
            }
            if (annotatedMethods==null || annotatedMethods.isEmpty()) {
                continue;
            }

            for (Map.Entry<Method, XxlJob> methodXxlJobEntry : annotatedMethods.entrySet()) {
                Method executeMethod = methodXxlJobEntry.getKey();
                XxlJob xxlJob = methodXxlJobEntry.getValue();
                // regist
                registJobHandler(xxlJob, bean, executeMethod);
            }

        }
    }
```

è¿™é‡Œæ˜¯ä½¿ç”¨`MethodIntrospector` çš„selectMethodsæ–¹æ³•ï¼Œæ­é…Springçš„`ApplicationContext` beanå¯¹è±¡å‰åæ–‡è·å–æ‰€æœ‰è¢«@xxlJobæ³¨é‡Šä¿®é¥°çš„methodï¼›

å…¶ä¸­è¿‡å»ç”±äºæœªå¤„ç† `@Lazy` æ³¨è§£ï¼Œå¯¼è‡´æœ¬è¯¥æ‡’åŠ è½½çš„ç±»åœ¨æ­¤å¤„è·å–æ‰€æœ‰ç±»æ—¶è¢«å¼ºè¡ŒåŠ è½½å¯¼è‡´æ‡’åŠ è½½å¤±æ•ˆï¼›ï¼ˆç°å·²ä¿®å¤ï¼‰

æœ€ç»ˆåœ¨ registJobHandler æ–¹æ³•ä¸­ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•çš„å°†`xxlJob.value` ä½œä¸ºkeyï¼Œé€šè¿‡å‰æ–‡è·å–çš„Classã€Methodã€`xxlJob.init`ã€`xxlJob-destory` ç»„è£…çš„MethodHandler ä½œä¸ºValueï¼Œå¡åˆ°ConcurrentMapä¸­

### 2\ åˆå§‹åŒ–åŸºæœ¬å‚æ•°

```java
public void start() throws Exception {

    // init logpath
    XxlJobFileAppender.initLogPath(logPath);

    // init invoker, admin-client
    initAdminBizList(adminAddresses, accessToken);

    // init JobLogFileCleanThread
    JobLogFileCleanThread.getInstance().start(logRetentionDays);

    // init TriggerCallbackThread
    TriggerCallbackThread.getInstance().start();

    // init executor-server
    initEmbedServer(address, ip, port, appname, accessToken);
}
```

å¾ˆç®€å•çš„åŸºæœ¬ä¿¡æ¯ä¸é…ç½®çš„åˆå§‹åŒ–è®¾ç½®ï¼š

1. æ—¥å¿—åœ°å€è®¾ç½®
2. æœåŠ¡ç«¯åˆ—è¡¨çš„è®°å½•
3. æ—¥å¿—æ¸…ç†çº¿ç¨‹çš„å¼€å¯
4. æ—¥å¿—å›è°ƒçº¿ç¨‹çš„å¼€å¯
5. nettyé€šè®¯å®¢æˆ·ç«¯å‚æ•°çš„è®¾ç½®

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨xxlJobä¸­é’ˆå¯¹çº¿ç¨‹çš„ä¸€ä¸ªå¤„ç†ï¼šå†å²é—ç•™é—®é¢˜

ä¸Šæ–‡æœ‰æåˆ°`xxlJob`æ˜¯ä»16å¹´å¼€å§‹å¼€æºï¼Œä½†æ˜¯å…·ä½“å¼€å‘æ—¶é—´å¯èƒ½æ›´æ—©ï¼Œä¹Ÿå°±å¯¼è‡´äº†å½“æ—¶çš„ç³»ç»Ÿå®šæ—¶ä»»åŠ¡çš„è®¾è®¡æœ‰ä¸€äº›ç‘•ç–µï¼Œæ¯”æ–¹è¯´æ—¥å¿—æ¸…ç†çº¿ç¨‹ï¼š

```java
        localThread = new Thread(new Runnable() {
            @Override
            public void run() {
                while (!toStop) {
                    try {
                        File[] childDirs = new File(XxlJobFileAppender.getLogPath()).listFiles();
                        if (childDirs!=null && childDirs.length>0) {
							//................
                            for (File childFile: childDirs) {
								//................
                                if ((todayDate.getTime()-logFileCreateDate.getTime()) >= logRetentionDays * (24 * 60 * 60 * 1000) ) {
                                    FileUtil.deleteRecursively(childFile);
                                }
                            }
                        }
                    } catch (Exception e) {
						//................
                    }
                    try {
                        TimeUnit.DAYS.sleep(1);
                    } catch (InterruptedException e) {
                        if (!toStop) {
                            logger.error(e.getMessage(), e);
                        }
                    }
                }
            }
        });
```

å¯ä»¥çœ‹åˆ°å¼€å¯ä¸€ä¸ªæ­»å¾ªç¯çº¿ç¨‹ï¼Œä½¿ç”¨å¤–ç½®çš„booleanå‚æ•°æ§åˆ¶ï¼Œæ‰§è¡Œä¸€æ¬¡ä¹‹åçº¿ç¨‹ `Sleep` 1å¤©

è¿™ç§ç±»å‹çš„æ“ä½œï¼Œå…¶å®åœ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒç³»ç»Ÿæ¥çœ‹ï¼Œå®Œå…¨å¯ä»¥ç”±æœåŠ¡ç«¯åˆå§‹åŒ–è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŸºäºå®¢æˆ·ç«¯çš„æ¯å¤©æ‰§è¡Œä¸€æ¬¡çš„æ—¥å¿—æ¸…ç†ä»»åŠ¡ï¼Œèµ„æºæ¶ˆè€—åˆ°æœåŠ¡ç«¯è€Œéå®¢æˆ·ç«¯ã€‚

### 3\ å¼€å¯æœåŠ¡ç«¯é€šè®¯

é€šè®¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. å‘æœåŠ¡ç«¯å‘é€çš„å¿ƒè·³æ³¨å†ŒåŒ…ï¼ˆå­˜æ´»ï¼‰
2. ä¸æœåŠ¡ç«¯çš„æŒ‡ä»¤äº¤æ¢ï¼Œæ¯”å¦‚å›è°ƒã€å‘½ä»¤æ‰§è¡Œ...

**æ³¨å†ŒåŒ…**ï¼š

åœ¨ `ExecutorRegistryThread` ä¸­ï¼Œä½¿ç”¨äº†å‰æ–‡æåˆ°çš„æ­»å¾ªç¯çº¿ç¨‹ï¼š

```java
         public void run() {
                while (!toStop) {
                    try {
						//................
                        for (AdminBiz adminBiz: XxlJobExecutor.getAdminBizList()) {
                            try {
                                ReturnT<String> registryResult = adminBiz.registry(registryParam);
                                if (registryResult!=null && ReturnT.SUCCESS_CODE == registryResult.getCode()) {
                                    registryResult = ReturnT.SUCCESS;
                                    break;
                                }
                            } catch (Exception e) {                            }
                        }
                    } catch (Exception e) {
						//................
                    }
                    try {
                        if (!toStop) {
                            TimeUnit.SECONDS.sleep(RegistryConfig.BEAT_TIMEOUT);
                        }
                    } catch (InterruptedException e) {
						//................
                    }
                }
                try {
                    //................
                    for (AdminBiz adminBiz: XxlJobExecutor.getAdminBizList()) {
                        try {
                            ReturnT<String> registryResult = adminBiz.registryRemove(registryParam);
                            if (registryResult!=null && ReturnT.SUCCESS_CODE == registryResult.getCode()) {
                                registryResult = ReturnT.SUCCESS;
                                break;
                            }
                        } catch (Exception e) {
						//................
                        }
                    }
                } catch (Exception e) {
						//................
                }
            }
```

æ¯ä¸€æ¬¡æ‰§è¡Œå®Œï¼Œç¡çœ 30sï¼Œå› æ­¤æ³¨å†ŒåŒ…æ˜¯å›ºå®šçš„æ¯30sä¸ŠæŠ¥ä¸€æ¬¡ï¼›

å½“é¡¹ç›®æš‚åœæ—¶ï¼Œåˆ™å‘æœåŠ¡ç«¯å‘é€æ³¨é”€æŒ‡ä»¤ï¼›

**æŒ‡ä»¤åŒ…**

å®¢æˆ·ç«¯ä½¿ç”¨ä»¥ä¸‹çº¿ç¨‹æ± æ¥æ”¶æœåŠ¡ç«¯æŒ‡ä»¤ï¼š

```java
 ThreadPoolExecutor bizThreadPool = new ThreadPoolExecutor(
                        0,
                        200,
                        60L,
                        TimeUnit.SECONDS,
                        new LinkedBlockingQueue<Runnable>(2000),
                        new ThreadFactory() {
                            @Override
                            public Thread newThread(Runnable r) {
                                return new Thread(r, "xxl-job, EmbedServer bizThreadPool-" + r.hashCode());
                            }
                        },
                        new RejectedExecutionHandler() {
                            @Override
                            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
                                throw new RuntimeException("xxl-job, EmbedServer bizThreadPool is EXHAUSTED!");
                            }
                        });
```

çº¿ç¨‹æ± æ— æ³•é…ç½®ï¼Œå†™æ­»å›ºå®šï¼›å› æ­¤åœ¨`xxlJob`ä¸­å®¢æˆ·ç«¯æœ€å¤§èƒ½æ”¯æŒçš„å¹¶å‘ä»»åŠ¡é‡ = ç©ºé—²æ ¸å¿ƒ*2000ï¼Œæ‹’ç»ç­–ç•¥ä¸ºæŠ›å‡ºå¼‚å¸¸

åœ¨**EmbedHttpServerHandler**ä¸­nettyæ¥æ”¶æ¶ˆæ¯ï¼Œå¤„ç†ä»¥ä¸‹æŒ‡ä»¤é›†ï¼š

1. /beat çº¯æµ‹è¯•
2. /idleBeat æµ‹è¯•æœ‰æ— åœ¨è¿è¡Œçš„é˜Ÿåˆ—
3. /run æ‰§è¡Œç›®æ ‡ä»»åŠ¡
4. /kill æš‚åœç›®æ ‡ä»»åŠ¡
5. /log è¯»å–ç›®æ ‡ä»»åŠ¡

åœ¨è°ƒåº¦ä¸­å¿ƒä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å®¢æˆ·ç«¯å¦‚ä½•æ‰§è¡Œç›®æ ‡åŠ¨ä½œ /runæŒ‡ä»¤ï¼›

åœ¨è¿™ä¸ªæŒ‡ä»¤ä¸­ï¼Œå®¢æˆ·ç«¯çš„å¤„ç†ä»…ä»…åªæ˜¯å°†æœåŠ¡ç«¯å‘é€ç»™æ¥çš„ä»¥ä¸‹å‚æ•°ï¼š

```json
{
    "jobId":1,
    "glueType": "BEAN" ,// ä»»åŠ¡æ¨¡å¼
    "executorHandler":"xxlJobalue", //@xxljobä¸­çš„value
    "executorParams":"æ‰§è¡Œæ—¶çš„ä¸Šä¸‹æ–‡å‚æ•°"
    //...
}
```

è§£ææ‹¿åˆ°åˆå§‹åŒ–æ—¶æ³¨å†Œçš„ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå°è£…æˆä¸€ä¸ªçº¿ç¨‹å¹¶ä¸”å¼€å¯ï¼Œæ”¾åˆ°æœ¬åœ°å†…å­˜ä¸­ï¼Œkeyä¸ºjobId

![](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-23/2.png)

![](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-23/3.png)

çº¿ç¨‹å¼€å¯åï¼Œå†å°†æœ¬æ¬¡éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å‚æ•°ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯å‘é€è¿‡æ¥çš„ä¿¡æ¯æ¨åˆ°æ­¤çº¿ç¨‹çš„å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼›

å¹¶ä¸”ï¼Œå½“å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­æœ‰æœ¬æ¬¡ä»»åŠ¡çš„JobIdæ—¶ï¼ŒæŠ¥é”™æç¤ºä»»åŠ¡æ‰§è¡Œä¸­ï¼›

è€Œè¿™ä¸ªçº¿ç¨‹çš„åŠ¨ä½œä¹Ÿå°±å¾ˆç®€å•äº†ï¼Œåˆæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­æ‹¿åˆ°ä»»åŠ¡ï¼Œæ‰§è¡Œï¼›

```java
					//æœ¬åœ°è¯·æ±‚çš„ä¸Šä¸‹æ–‡ InheritableThreadLocal
					XxlJobContext xxlJobContext = new XxlJobContext(
							triggerParam.getJobId(),
							triggerParam.getExecutorParams(),
							logFileName,
							triggerParam.getBroadcastIndex(),
							triggerParam.getBroadcastTotal());
					XxlJobContext.setXxlJobContext(xxlJobContext);

					if (triggerParam.getExecutorTimeout() > 0) {
                        //è®¾ç½®äº†è¶…æ—¶æ—¶é—´æ—¶æ‰§è¡Œ
						Thread futureThread = null;
						try {
							FutureTask<Boolean> futureTask = new FutureTask<Boolean>(new Callable<Boolean>() {
								@Override
								public Boolean call() throws Exception {
									XxlJobContext.setXxlJobContext(xxlJobContext);
									handler.execute();
									return true;
								}
							});
							futureThread = new Thread(futureTask);
							futureThread.start();
							Boolean tempResult = futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);
						} catch (TimeoutException e) {
							XxlJobHelper.log("<br>----------- xxl-job job execute timeout");
							XxlJobHelper.log(e);
							XxlJobHelper.handleTimeout("job execute timeout ");
						} finally {
							futureThread.interrupt();
						}
					} else {
						// æ‰§è¡Œ
						handler.execute();
					}
```

è¿™å—ä»£ç é˜…è¯»æäº†ä¸ª**Issues** ï¼š[https://github.com/xuxueli/xxl-job/issues/3546](https://github.com/xuxueli/xxl-job/issues/3546)

![](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-23/4.png)

åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹ç¼“å­˜ä¼šä¿ç•™30sï¼Œ30så†…æ²¡æœ‰ä»»åŠ¡è¿‡æ¥æ¸…é™¤è¯¥çº¿ç¨‹å†…å­˜:

```java
if (idleTimes > 30) {
    if(triggerQueue.size() == 0) {	
        XxlJobExecutor.removeJobThread(jobId, "excutor idel times over limit.");
    }
```

é™¤æ­¤ä¹‹å¤–ï¼Œä»»åŠ¡æ‰§è¡Œå¼€å§‹æ—¶ï¼Œæ‰§è¡Œä¸­ï¼Œæ‰§è¡Œåï¼›

åˆ†åˆ«éƒ½ä¼šå‘æ—¥å¿—å›è°ƒçº¿ç¨‹ä¸­çš„å¾…æ‰§è¡Œé˜Ÿåˆ—é‡Œæ¨å…¥å½“å‰æ—¥å¿—ï¼Œæ—¥å¿—å›è°ƒçº¿ç¨‹çš„å¤„ç†å’Œä¸Šæ–‡ä¸­æåˆ°çš„æ‰€æœ‰çº¿ç¨‹ä¸€æ¨¡ä¸€æ ·ï¼ˆå†å²é—ç•™é—®é¢˜ï¼‰ã€‚

è¿™ä¹Ÿæ˜¯xxlJobæºç éå¸¸å®¹æ˜“é˜…è¯»çš„åŸå› 

## æœåŠ¡ç«¯

æœåŠ¡ç«¯ç”±äºæœ‰é¡µé¢çš„æ“ä½œï¼Œæ‰€ä»¥æ¥å£å’ŒæœåŠ¡æ¯”è¾ƒå¤šï¼šæ–°å¢ã€æ›´æ–°ã€åˆ é™¤ã€å¯¼å‡ºã€å›¾è¡¨ã€æ³¨å†Œç­‰ç­‰....å¤§å¤šæ˜¯ç®€å•çš„CRUDï¼›

æ‰€ä»¥æœ¬æ–‡åªå…³æ³¨ `xxlJob` å¦‚ä½•å®Œæˆä»»åŠ¡è°ƒåº¦è¿™ä¸€æ ¸å¿ƒåŠŸèƒ½ï¼›

ä¸€ä¸ªä»»åŠ¡çš„å‘èµ·ä¸€å®šæœ‰ä»¥ä¸‹ä¸‰æ­¥ï¼š

1. æ‰¾åˆ°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡
2. æ‰§è¡Œä»»åŠ¡
3. æ•´ç†æ®‹å±€

### 1\ æ‰§è¡Œä»»åŠ¡å‘ç°

`xxlJob` ä¹Ÿä¸ä¾‹å¤–ï¼Œä¹Ÿæ˜¯å…ˆæ‰¾åˆ°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåœ¨**JobScheduleHelper**ç±»ä¸­ï¼š

å¼€å¯ä¸€ä¸ªæ¯1sæ‰§è¡Œä¸€æ¬¡çš„å¾ªç¯çº¿ç¨‹ä»»åŠ¡ï¼š

```java
public static final long PRE_READ_MS = 5000;  
	public void run() {
                TimeUnit.MILLISECONDS.sleep(5000 - System.currentTimeMillis()%1000 );
      			//ä¸€æ¬¡æ‰§è¡Œçš„æœ€å¤§ä»»åŠ¡é‡
                int preReadCount = (XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax() + XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax()) * 20;

                while (!scheduleThreadToStop) {
						//.................
                    try {
						//åŸºäºæ•°æ®åº“ æ‹¿åˆ°ä¸€æŠŠå…¨å±€é”
                        preparedStatement = conn.prepareStatement(  "select * from xxl_job_lock where lock_name = 'schedule_lock' for update" );
                        preparedStatement.execute();
                        long nowTime = System.currentTimeMillis();
                        //æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åœ¨æœªæ¥5ç§’å†…çš„ä»»åŠ¡
                        List<XxlJobInfo> scheduleList = XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().scheduleJobQuery(nowTime + PRE_READ_MS, preReadCount);
                        
                        //.................
```

å¾ªç¯å‡ºæœ¬æ¬¡æ—¶é—´ç‰‡ä¸­éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¾€ä¸‹èµ°è¿›å…¥åˆ¤æ–­ä¸åˆ†æ”¯å¤„ç†æµç¨‹ï¼Œä¸‰ç§æƒ…å†µï¼š

1. æŸ¥è¯¢5ç§’å†…ä»»åŠ¡æˆ–è€…å…¶ä»–å› ç´ å¯¼è‡´ï¼Œå½“å‰æ—¶é—´è¶…è¿‡äº†æŸ¥è¯¢sqlæ—¶æœªæ¥10sçš„æ—¶é—´
2. æŸ¥è¯¢5ç§’å†…ä»»åŠ¡æˆ–è€…å…¶ä»–å› ç´ å¯¼è‡´ï¼Œå½“å‰æ—¶é—´è¶…è¿‡äº†æŸ¥è¯¢sqlæ—¶æœªæ¥5sçš„æ—¶é—´
3. æ­£å¸¸æƒ…å†µï¼Œ5så†…çš„ä»»åŠ¡

å‰ä¸¤è€…æ ¹æ®ä»»åŠ¡ç±»å‹ï¼Œç›´æ¥æ‰§è¡Œä»»åŠ¡åšè¡¥å¿åŠ¨ä½œï¼›

ç¬¬ä¸‰ä¸ªåˆ™æ˜¯å°†æ‰€æœ‰ä»»åŠ¡ï¼Œæ ¹æ® `(æ‰§è¡Œæ—¶é—´/1000)%60` å¾—åˆ°çš„å‡è¡¡åç§»é‡çš„æ–¹å¼æ¨åˆ°ä¸€ä¸ªä¸€ç§’æ‰§è¡Œä¸€æ¬¡çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­ï¼š

```java
int ringSecond = (int)((jobInfo.getTriggerNextTime()/1000)%60);
		//............
		// push async ring
        List<Integer> ringItemData = ringData.get(ringSecond);
        if (ringItemData == null) {
            ringItemData = new ArrayList<Integer>();
            ringData.put(ringSecond, ringItemData);
        }
        ringItemData.add(jobId);
```

è€Œè¿™ä¸ªä¸€ç§’ä¸€æ¬¡ï¼ˆå­˜åœ¨åç§»ï¼‰çš„çº¿ç¨‹æ‰€åšçš„äº‹å°±æ˜¾ç„¶æ˜“è§äº†ï¼š

<img src="https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2024-09-23/5.png" style="zoom:67%;" />

å› æ­¤ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä¼šè¢«åˆ†ç‰‡åœ¨5Så†…çš„ä¸€ä¸ªéšæœºçš„æƒé‡ä¸Šï¼Œç„¶åæ¯ç§’ä¸­å­˜åœ¨ä¸¤æ¬¡æ‰§è¡Œçš„å¯èƒ½ã€‚æœ€åçš„æƒ…å†µä»»åŠ¡ä¼šå­˜åœ¨**5s**çš„æå‰æ‰§è¡Œæˆ–è€…**4s**çš„å»¶æ—¶æ‰§è¡Œã€‚

### 2\ ä»»åŠ¡è°ƒåº¦

åœ¨ **JobTriggerPoolHelper** ä¸­ï¼Œå¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹ï¼š

```java
        fastTriggerPool = new ThreadPoolExecutor(
                10,
                XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax(),
                60L,
                TimeUnit.SECONDS,
                new LinkedBlockingQueue<Runnable>(1000),
                new ThreadFactory() {
                    @Override
                    public Thread newThread(Runnable r) {
                        return new Thread(r, "xxl-job, admin JobTriggerPoolHelper-fastTriggerPool-" + r.hashCode());
                    }
                });

        slowTriggerPool = new ThreadPoolExecutor(
                10,
                XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax(),
                60L,
                TimeUnit.SECONDS,
                new LinkedBlockingQueue<Runnable>(2000),
                new ThreadFactory() {
                    @Override
                    public Thread newThread(Runnable r) {
                        return new Thread(r, "xxl-job, admin JobTriggerPoolHelper-slowTriggerPool-" + r.hashCode());
                    }
                });
```

å‚æ•°åå¯è§ï¼Œä¸€ä¸ªå¿«ä»»åŠ¡è§¦å‘å™¨ï¼Œä¸€ä¸ªæ…¢ä»»åŠ¡è§¦å‘å™¨

å¿«æ…¢ä¾ç…§çš„æ ‡å‡†å¹¶éä»»åŠ¡æœ¬èº«ï¼Œè€Œæ˜¯å¿«çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œä¸­çš„è¶…æ—¶çº¿ç¨‹ï¼ˆå¤§äº500msæ‰§è¡Œæ—¶é—´çš„ï¼‰çš„æ€»æ•°ï¼š

```java
		ThreadPoolExecutor triggerPool_ = fastTriggerPool;
        AtomicInteger jobTimeoutCount = jobTimeoutCountMap.get(jobId);
        if (jobTimeoutCount!=null && jobTimeoutCount.get() > 10) {     
            triggerPool_ = slowTriggerPool;
        }
```

è¿™æ ·çš„å°å°è®¾è®¡ç»™äº†ä»»åŠ¡è°ƒåº¦å¾ˆå¤§çš„å¼¹æ€§ç©ºé—´ï¼Œè‡³å°‘é¿å…äº†æ…¢ä»»åŠ¡çš„å †ç§¯ï¼›è™½ç„¶åªæœ‰ä¸¤ä¸ªæ‰§è¡Œç©ºé—´ï¼Œä½†æ˜¯ä»”ç»†è€ƒè™‘å¤šäº†æµªè´¹èµ„æºï¼Œä¸¤ä¸ªä¹Ÿåˆšåˆšå¥½ï¼›

å…·ä½“çš„ä»»åŠ¡æ‰§è¡Œå¾ˆç®€å•ï¼Œå°†åœ¨é¡µé¢ä¸Šè®¾ç½®å¥½çš„å‚æ•°å°è£…å¥½å‘ç»™å®¢æˆ·ç«¯çš„ `netty` å®¢æˆ·ç«¯ï¼ŒæŒ‡ä»¤ä¸º **/run** 

å¦‚æ­¤ä¸€æ¥å°±å®Œæˆäº†ä»»åŠ¡è°ƒåº¦çš„åŠ¨ä½œ

### 3\ æ®‹å±€å¤„ç†

ä»»åŠ¡è°ƒåº¦å‘èµ·æˆåŠŸåï¼Œé¦–å…ˆæ˜¯è®°å½•æœ¬æ¬¡è°ƒåº¦æ—¥å¿—ï¼›

ç„¶åæ˜¯æ›´æ–°æ‰§è¡Œæ—¶é—´ï¼Œå°†æœ¬æ¬¡æ‰§è¡Œä»»åŠ¡çš„ `triggerNextTime` +5sæ›´æ–°åˆ°æ•°æ®åº“ä¸­ï¼›è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ç‚¹ï¼Œç”±äºå¯»æ‰¾æœªæ¥5sçš„è½®è¯¢æ“ä½œï¼Œä¸€ä¸ªä»»åŠ¡è®¾ç½®æ¯ç§’æ‰§è¡Œä¸€æ¬¡æ—¶çš„æœ€åçš„åå·®å¯èƒ½å¯è¾¾5s

ç„¶åæ˜¯åˆ¤æ–­æœ¬æ¬¡ 1 \æ‰§è¡Œä»»åŠ¡å‘ç° åŠ¨ä½œçš„ç¡çœ æ—¶é—´ï¼š

```java
                    long cost = System.currentTimeMillis()-start;


                    // Wait seconds, align second
                    if (cost < 1000) {  // scan-overtime, not wait
                        try {
                            // pre-read period: success > scan each second; fail > skip this period;
                            TimeUnit.MILLISECONDS.sleep((preReadSuc?1000:PRE_READ_MS) - System.currentTimeMillis()%1000);
                        } catch (InterruptedException e) {
                            if (!scheduleThreadToStop) {
                                logger.error(e.getMessage(), e);
                            }
                        }
                    }
```

æœ€é«˜æ˜¯æ¯ç§’è¿›è¡Œä¸€æ¬¡å‘ç°ï¼›

ä»»åŠ¡æ‰§è¡Œä¹‹åï¼ŒæœåŠ¡ç«¯ç­‰å¾…å®¢æˆ·ç«¯ç›®æ ‡ä»»åŠ¡è°ƒç”¨å›è°ƒæŒ‡ä»¤æ›´æ–°æ—¥å¿—ï¼Œç›´æ¥ä»»åŠ¡ç»“æŸã€‚

## æ€»ç»“

å¯è§xxljobæ˜¯ä¸€ä¸ªè®¾è®¡å¾ˆç®€å•æ˜äº†ä½†æ˜¯éå¸¸å¥½ç”¨çš„ç³»ç»Ÿï¼Œè™½ç„¶åœ¨æŸ¥é˜…è¿‡ç¨‹ä¸­å‘ç°æœ‰å¤§é‡çš„ä»£ç å—ï¼Œè®¾è®¡å­˜åœ¨æ›´å¥½çš„æ¨¡å¼ï¼Œæ›´å¥½çš„æ€§èƒ½å’Œæ‰©å±•æ€§æ›¿ä»£ã€‚

ä½†æ˜¯ä»16å¹´åˆ°ç°åœ¨çš„å¼€æºç³»ç»Ÿèƒ½è¢«è¿™ä¹ˆå¤šçš„å…¬å¸é€‰å‹ï¼Œä¹Ÿè¯æ˜äº†ç³»ç»Ÿå„ä¸ªçº¿ç¨‹è®¾è®¡çš„åˆç†æ€§ï¼›

æŸ¥é˜…ä¹‹åï¼Œæœªæ¥æ­å»ºè‡ªå·±ä½“ç³»çš„ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒæ€è·¯ä¹Ÿå°±éå¸¸æ˜ç¡®ï¼›ğŸ˜€
