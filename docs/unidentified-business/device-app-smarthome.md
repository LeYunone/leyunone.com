# 自动化场景

## 内循环

内循环搜索：DFS、BFS

## 天气条件

每个场景的天气条件都属于不同的经纬度，

相当于天气条件引擎运行时，需要拿到所有经纬度的天气然后与对应的条件判断

## 时段条件

时区，夏令时问题

周期定时问题

## 设备指令条件

条件的存储方式，redis？key的设计

## 场景信息更新

场景中的条件修改时，对应条件引擎中待判断的队列的数据刷新

## 时区转化

系统时区与家庭时间，以及APP上报时区的转化问题

## 热点条件

热点条件触发时，总执行场景很多，如何保证系统高效运行

# 消息中心

## 消息模型设计

使用策略模式 + 模板模式 巧妙设计

# 设备

很多很多的表和设备有关系

家庭 -  房间  - 设备

家庭 - 场景 - 设备

用户 - 设备 

消息 - 设备

导致如果设备出现解绑操作，比如家庭删除、房间删除、设备解绑都会出现牵一发而动全身的问题

**缓存【场景、场景条件、场景执行】表删除 **



**解决办法：** 通过一天一次读垃圾表，批量删除

# 夏令时

每个家庭会设置夏令时的开始时间和结束时间，如何去动态的自动维护其夏令时影响的时间变化

方案1：

定时任务，凌晨的时候执行一次，查询今天：会开发夏令时的家庭，和结束夏令时的家庭；

然后将一天分成每片一小时的24片，将对应的开始时间/结束时间，放到查询到的家庭的对应时间片上；

将查询到的家庭中的自动化场景的定时条件和设备定时任务，存入到待处理的家庭中。

然后当天执行这24个任务，这样夏令时的时区转化误差，最多为 01 -59,一小时左右的误差

方案2：

设计一个时间轮，当前时间片上去查询下一个时间片需要进行夏令时新时间维护的数据，并且存入到下一个时间片中；

所以当前时间片做两个事，一是执行上一个时间片传过来的需要处理的数据，二是生成下一个时间片需要处理的数据；

这样相比第一个的优势，性能更高，且代码可读性强，并且具有一定的灾难恢复性。

# 设备状态同步设计

MQTT + redis + 权限控制 + 动态订阅 + 心跳包设计

# 用户个性化设置的清理流

