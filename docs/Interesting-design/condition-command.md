---
date: 2023-06-26
title: 条件决定任务执行需求设计「自动化场景」
category: 设计
tag:
  - 设计
head:
  - - meta
    - name: keywords
      content: Java,自动化场景,乐云一
  - - meta
    - name: description
      content: 由一个或多个条件决定任务是否执行
---
# 自动化场景

自动化场景，白话点来说，即「**由一个或多个条件决定任务是否执行**」的功能。

对于这种模式的功能，任务方面的开发并不难，整个功能的难度是随着条件的多种化而变动的。

本文将提出以下几点，当他们作为条件时的需求开发难题及对应的解决方式。

## 定时

首先定时应该是这类模式功能最常见的条件；

比如我们经常接触的「闹钟」

当时间到达某个时间点时，任务触发。

那么关于时间点是否到达的判断也有两种不同的说法：

1. 秒级判断
2. 分级判断

由需求决定解决方案，当功能要求秒级定时，就像闹钟一样；当功能要求分级时，由于时间限度被拉长，业务可执行时间也会变长。

不过由于个体应用级别不同，下面将分享一下我对于负载健康时以及资源贫乏时的解决方案。

### 负载健康

在应用无需担心性能问题时：

1、最暴力的肯定是逐秒去判断当前时间是否有可执行的条件，而怎么去获取，不管是通过DB还是缓存差距都不会大。

2、将一天分为若干个时间片，比如24片；在进入当前时间片的那一刻，将符号当前时间片时间的条件全部拿出来，放入当前时间片中待处理数据队列中，等待处理器逐秒判断。

简单原理如下图：

![](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2023-06-26/aa4b5e67-12cd-498e-bee0-0d493a696fa7.png)

优点：相比暴力逐秒判断，有两个明显的优势，一是获取当前时间数据的动作变少，同时也会更好管理；二是逐秒判断变成了一个可能执行的行为。

3、采用两个线程构建一个时间循环，和玩一个圈内的接力游戏一样：

第一个线程执行完之后，获取第二个线程的待判断时间数据；

第二个线程拿到数据，开始执行，执行完了之后做线程一，一样的动作；

简单原理图如下：

![	](https://leyunone-img.oss-cn-hangzhou.aliyuncs.com/image/2023-06-30/6e98f4d5-3826-41bf-bed9-d48d789d7171.png)

优点：线程创建少的同时，逐秒判断也变成了一个可能执行的行为。同时也可以跨时间去删减待判断时间数据

缺点：待判断数据的一致性问题

### 资源贫乏

当当前应用无法支持逐秒判断的线程时，就必须引入第三方服务或是插件了；

这里推荐使用RabbitMq的延时队列，延时插件：[https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases)

不过这是在消息队列压力不大的前提下采取的最有利方案，同替平也有很多。

除此之外，也可以考虑采用缓存过期、DelayQueue等方式最低限度的降低逐秒判断的动作

当然了，最佳方案是直接加个服务器.:)

## 天气

天气作为条件，面临的最大问题是随着天气条件数量的增多，由于每个条件需要的经纬度不同；

导致当前的天气数据也会随着条件数量的增多，逐渐变大。

同时，由于天气具有时效性，在小时制、半天制、一天制甚至分/半小时制中对天气数据的爬取要求又会逐步变高。

最后我们需要面对的是两个问题：

1. 各地天气数据的存储
2. 每个时段内判断天气条件是否达成

### 天气数据

首先是收集，所有天气条件的经纬度

将查询当天条件的经纬度数据

## 内循环问题





