# 异步消息中事务的设计

## 前言

在非常非常多的系统中都会存在两阶段或以上业务强绑定关系的场景，比如用户购买商品成功后，累加用户的积分。在开发人眼中，以上的动作是：

1. `if` 用户购买商品成功 ，`return` 商品库存扣除
2. `if` 用户控制库存扣除，`return` 累加该商品的积分

当然了，这只是一个不显著的例子。我想表明的是，在业务系统设计中所逃不开的一点：**两个功能点高度耦合，但是需要保存一致事务**。

在我的开发日常中，发现小的系统很容易解决这点：单点架构仅通过一个事务控制即可。而大系统则由于服务中心化，分布式、AOP等等因素的影响使得这一问题的考虑需逐渐加深。

所以为了针对：**如何设计功能不耦合，但是事务耦合的需求** 这一要点，记录一篇思路上的整合规划；

按照惯例，将我们的文章放在以下一个简单例子的背景下：

**简单例子**

这样关系的需求有太多太多，比如前文提到的商城中的用户购买后加积分、功能触发成功后，消息推送、xxxx后，进行xxxx等等。

所以还是用最简单的案例：

你接到了一个需求，需要在用户购买一件商品成功后，将该商品的积分累加到用户信息上；

## 需求分析

现在你拿到了需求，绕绕头，这不就是一个很简单的订单业务，下单成功把用户的积分加上就好了吗。因此你预估了以下任务的工时：

1. 用户下单功能
2. 用户累加积分方法

于是在你的一堆方案设计下，用户可以成功下单了，